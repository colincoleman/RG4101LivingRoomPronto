/*!
  @title linnControl
  @version 1.0
  @author Linn Products
 */

var lpec=lpec;var utils={};utils.htmlDecode=function(a){return a.replace(/&amp;/g,"&").replace(/&quot;/g,'"').replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&apos;/g,"'").replace(/&nbsp;/g," ")};function timestamp(a){}var elab={add:function(a){}};var doNothing=function(){};var lpec={};lpec.addEventCallback=function(g,b,d,a){if(b==null){b=""}if(d==null){d=""}if(a==null){a=""}if(b==""){throw new Error("Match can't be empty string in lpec.addEventCallback");return}var f=d+"/"+a;if(f=="/"){f=""}lpec.eventCallbacks.push({callback:g,match:b,service:f});for(var c in lpec.events){var e=lpec.events[c];if(e.match==b){if((f=="")||(f==e.service)){g(e.value)}}}};lpec.action=function(b,d,a,c){if(d==null){d=doNothing}if(a==null){a=doNothing}if(c==null){c=true}lpec.write("ACTION "+b,lpec.REQUEST_TYPE.ACTION,c,d,a)};lpec.ipAddress="{ip-address-undefined}";lpec.telnetPort=23;lpec.initialised=false;lpec.previouslyConnectedToDs=false;lpec.actSocket=null;lpec.currentRequest=null;lpec.outstandingRequests=[];lpec.evtSocket=null;lpec.evtData="";lpec.evtErrorCount=0;lpec.events=[];lpec.eventCallbacks=[];lpec.subscriptions=[];lpec.wifi=true;lpec.sleep=false;lpec.REQUEST_TYPE={SUBSCRIBE:0,UNSUBSCRIBE:1,ACTION:2};lpec.initialiseActionSocket=function(a){lpec.ipAddress=a;try{lpec.actSocket=new TCPSocket(true);lpec.actSocket.connect(a,lpec.telnetPort,250)}catch(b){lpec.actSocket=null;return false}return true};lpec.initialiseEventSocket=function(a){lpec.ipAddress=a;try{lpec.evtSocket=new TCPSocket(false);lpec.evtSocket.onData=lpec.onEvtData;lpec.evtSocket.onClose=lpec.onEvtClose;lpec.evtSocket.onIOError=lpec.onEvtIOError;lpec.evtSocket.onTimeout=lpec.onEvtTimeout;lpec.evtSocket.onConnect=lpec.onEvtConnect;lpec.evtSocket.connect(a,lpec.telnetPort,250)}catch(b){lpec.evtSocket=null;return false}return true};lpec.initialisationComplete=function(){var c;var b=false;var a=false;while(a==false){try{c=lpec.actSocket.read(1024,100);b=true}catch(d){if(b==true){a=true}}}lpec.initialised=true;lpec.writeTaskTask()};lpec.writeTask=function(){if(lpec.currentRequest!=null){return}if(!lpec.initialised){return}if(lpec.outstandingRequests.length==0){return}var a=lpec.outstandingRequests.shift();if(lpec.sleep){return}switch(a.requestType){case lpec.REQUEST_TYPE.SUBSCRIBE:case lpec.REQUEST_TYPE.UNSUBSCRIBE:try{lpec.currentRequest=a;lpec.evtSocket.write(a.message+"\r\n")}catch(c){lpec.evtSocket.close();lpec.evtSocket=null;lpec.currentRequest=null}break;case lpec.REQUEST_TYPE.ACTION:try{lpec.currentRequest=a;lpec.actSocket.write(a.message+"\r\n")}catch(c){lpec.actSocket.close();lpec.actSocket=null;lpec.currentRequest=null}var b="";while(b.lastIndexOf("\r\n")==-1){try{b+=lpec.actSocket.read(4096,20)}catch(c){}}b=b.slice(0,-2);lpec.handleDsResponse(b);break;default:}};lpec.writeTaskTask=function(){try{lpec.writeTask()}catch(a){}try{Activity.scheduleAfter(10,lpec.writeTaskTask)}catch(a){GUI.alert("Activity.scheduleAfter[2] "+a)}};lpec.write=function(d,a,f,e,b){if(b==null){b=doNothing}if(e==null){e=doNothing}var c={message:d,requestType:a,decodeXML:f,callback:e,errorCallback:b};lpec.outstandingRequests.push(c);lpec.writeTask()};lpec.handleDsResponse=function(d){if(d==""){return}var b=d.indexOf(" ");var a=[];if(b==-1){a=[d,""]}else{a=[d.slice(0,b),d.slice(b+1)]}var c=lpec.currentRequest;if(a[0]=="RESPONSE"||a[0]=="SUBSCRIBE"||a[0]=="ERROR"){lpec.currentRequest=null}lpec.writeTask();switch(a[0]){case"RESPONSE":lpec.handleLpecResponse(a[1],c);break;case"SUBSCRIBE":lpec.handleLpecSubscribe(a[1],c);break;case"EVENT":lpec.handleLpecEvent(a[1]);break;case"UNSUBSCRIBE":lpec.handleLpecUnSubscribe(a[1]);break;case"ALIVE":lpec.handleLpecAlive(a[1]);break;case"BYEBYE":lpec.handleLpecByebye(a[1]);break;case"ERROR":lpec.handleLpecError(a[1],c);break;default:}};lpec.handleLpecResponse=function(h,d){var a=[];while(h.length>0){var f;var c=h.indexOf('"');var b=h.indexOf('"',c+1);if(d.decodeXML){f=utils.htmlDecode(h.slice(c+1,b))}else{f=h.slice(c+1,b)}h=h.slice(b+2);a.push(f)}try{d.callback(a)}catch(g){}};lpec.handleLpecError=function(c,a){try{a.errorCallback(c)}catch(b){}};lpec.handleLpecAlive=doNothing;lpec.handleLpecByebye=doNothing;lpec.onEvtData=function(){lpec.evtErrorCount=0;var a="\r\n";try{lpec.evtData+=lpec.evtSocket.read()}catch(f){lpec.evtData=""}lpec.previouslyConnectedToDs=true;var c=lpec.evtData.lastIndexOf(a);if((c+2)==lpec.evtData.length){var b=lpec.evtData.split(a);lpec.evtData="";for(var d=0;d<b.length;d++){lpec.handleDsResponse(b[d])}}};lpec.onEvtConnect=function(){if(!lpec.previouslyConnectedToDs){lpec.previouslyConnectedToDs=true;lpec.initialisationComplete()}};lpec.onEvtIOError=function(a){lpec.closeEvtSocket();if(lpec.previouslyConnectedToDs){gotoHomePage()}};lpec.onEvtClose=function(){lpec.closeEvtSocket()};lpec.onEvtTimeout=function(a){lpec.closeEvtSocket();if(lpec.previouslyConnectedToDs){gotoHomePage()}};lpec.closeEvtSocket=function(){lpec.evtSocket.close();lpec.evtSocket=null;lpec.currentRequest=null};lpec.handleLpecEvent=function(h){var c=lpec.parseLpecEventSubId(h);var b=lpec.parseLpecEvent(h);var a=lpec.subscriptions[c].service;if(b.length==0){return}for(var d=0;d<b.length;d++){var f={service:a,match:b[d].name,value:b[d].value};lpec.events[b[d].name]=f;try{lpec.doSingleEventCallback(f)}catch(g){}}};lpec.doSingleEventCallback=function(b){for(var a=0;a<lpec.eventCallbacks.length;a++){var c=lpec.eventCallbacks[a];if(c.match==b.match){try{if(c.service==""){c.callback(b.value)}else{if(c.service==b.service){c.callback(b.value)}else{}}}catch(d){}}}};lpec.parseLpecEventSubId=function(c){var a=c.indexOf(" ");var b=c.slice(0,a);return b};lpec.parseLpecEvent=function(g){var a=[];var e="";var f="";var c=0;var b=0;c=g.indexOf(" ");b=g.indexOf(" ",c+1);var d=g.slice(0,c);g=g.slice(b+1);while(g.length>0){c=g.indexOf(" ");if(c==-1){return a}else{e=g.slice(0,c);c=g.indexOf('"');b=g.indexOf('"',c+1);f=utils.htmlDecode(g.slice(c+1,b));g=g.slice(b+2);a.push({name:e,value:f})}}return a};lpec.subscribeAll=function(){lpec.subscribe("Ds","Info");if(pronto.variant==pronto.VARIANT_TYPE.DS){lpec.subscribe("Ds","Time");lpec.subscribe("Ds","Playlist")}if(pronto.variant==pronto.VARIANT_TYPE.RADIO){lpec.subscribe("Ds","Radio");lpec.subscribe("Ds","Time")}lpec.subscribe("Ds","Product");if(configuration.preAmpType==2){lpec.subscribe("Preamp","Product")}if(configuration.preAmpType==1){lpec.subscribe("Ds","Volume")}else{if(configuration.preAmpType==2){lpec.subscribe("Preamp","Volume")}}};lpec.subscribe=function(c,a){var d=c+"/"+a;function e(g){var f={};f.service=d;f.subscription=g;lpec.subscriptions[g]=f}function b(f){}lpec.write("SUBSCRIBE "+c+"/"+a,lpec.REQUEST_TYPE.SUBSCRIBE,true,e,b)};lpec.unSubscribeAll=function(){if(lpec.subscriptions.length>0){lpec.write("UNSUBSCRIBE",lpec.REQUEST_TYPE.UNSUBSCRIBE);lpec.subscriptions=[]}};lpec.handleLpecSubscribe=function(c,a){try{a.callback(c)}catch(b){}};lpec.handleLpecUnSubscribe=function(a){lpec.currentRequest=null};lpec.onSleep=function(){if(lpec.evtSocket!=null){lpec.unSubscribeAll()}lpec.sleep=true};lpec.onWake=function(){var a=System.getNetlinkStatus();switch(a){case"wifi-level1":case"wifi-level2":case"wifi-level3":case"wifi-level4":case"eth-ok":if(lpec.evtSocket!=null){lpec.closeEvtSocket()}lpec.initialiseEventSocket(configuration.dsIPAddress);try{Activity.scheduleAfter(350,lpec.subscribeAll)}catch(b){GUI.alert("Activity.scheduleAfter[3] "+b)}lpec.wifi=true;break;default:lpec.wifi=false}lpec.sleep=false};lpec.onNetlinkEvent=function(a){if(!lpec.sleep){switch(a){case"disabled":case"sleeping":case"wifi-disconnected":case"wifi-noip":case"wifi-standalone":case"ethdisconnected":case"eth-noip":if(lpec.wifi){if(lpec.evtSocket!=null){lpec.unSubscribeAll()}lpec.wifi=false}break;case"wifi-level1":case"wifi-level2":case"wifi-level3":case"wifi-level4":case"eth-ok":if(!lpec.wifi){lpec.wifi=true;if(lpec.evtSocket!=null){lpec.closeEvtSocket()}lpec.initialiseEventSocket(configuration.dsIPAddress);try{Activity.scheduleAfter(350,lpec.subscribeAll)}catch(b){GUI.alert("Activity.scheduleAfter[4] "+b)}}break;default:}}};lpec.handleSleep=function(){currActivity=CF.activity("");currActivity.onSleep=lpec.onSleep;currActivity.onWake=lpec.onWake};lpec.handleNetlinkEvent=function(){System.addEventListener("netlink",lpec.onNetlinkEvent)};lpec._start=function(){lpec.initialiseActionSocket(configuration.dsIPAddress);lpec.initialiseEventSocket(configuration.dsIPAddress);try{Activity.scheduleAfter(350,lpec.subscribeAll);Activity.scheduleAfter(2990,lpec.handleNetlinkEvent);Activity.scheduleAfter(3000,lpec.handleSleep)}catch(a){GUI.alert("Activity.scheduleAfter[5] "+a)}};lpec.byebye=function(){};elab.add("lpec",null,lpec._start);var lpecMessages={};lpecMessages.mute=function(){lpec.action(lpecMessages.volume+' 1 SetMute "1"')};lpecMessages.unMute=function(){lpec.action(lpecMessages.volume+' 1 SetMute "0"')};lpecMessages.volumeDec=function(){lpec.action(lpecMessages.volume+" 1 VolumeDec")};lpecMessages.volumeInc=function(){lpec.action(lpecMessages.volume+" 1 VolumeInc")};lpecMessages.preampSetSourceIndex=function(a){lpec.action('Preamp/Product 1 SetSourceIndex "'+a+'"')};lpecMessages.preampSetStandby=function(a){lpec.action('Preamp/Product 1 SetStandby "'+a+'"')};lpecMessages.play=function(){lpec.action(lpecMessages.ds+" 1 Play")};lpecMessages.pause=function(){lpec.action(lpecMessages.ds+" 1 Pause")};lpecMessages.next=function(){lpec.action(lpecMessages.ds+" 1 Next")};lpecMessages.previous=function(){lpec.action(lpecMessages.ds+" 1 Previous")};lpecMessages.stop=function(){lpec.action(lpecMessages.ds+" 1 Stop")};lpecMessages.playlistRead=function(b,c,a){lpec.action('Ds/Playlist 1 Read "'+b+'"',c,a)};lpecMessages.playlistReadList=function(b,c,a){lpec.action('Ds/Playlist 1 ReadList "'+b+'"',c,a)};lpecMessages.dsSetSourceIndexByName=function(a){lpec.action('Ds/Product 1 SetSourceIndexByName "'+a+'"')};lpecMessages.dsSetSourceIndex=function(a){lpec.action('Ds/Product 1 SetSourceIndex "'+a+'"')};lpecMessages.dsSetStandby=function(a){lpec.action('Ds/Product 1 SetStandby "'+a+'"')};lpecMessages.seekTrackId=function(a){lpec.action(lpecMessages.ds+' 1 SeekId "'+a+'"')};lpecMessages.playlistDelete=function(a){lpec.action('Ds/Playlist 1 DeleteId "'+a+'"')};lpecMessages.playlistDeleteAll=function(){lpec.action("Ds/Playlist 1 DeleteAll")};lpecMessages.playlistRepeatOn=function(){lpec.action('Ds/Playlist 1 SetRepeat "1"')};lpecMessages.playlistRepeatOff=function(){lpec.action('Ds/Playlist 1 SetRepeat "0"')};lpecMessages.playlistShuffleOn=function(){lpec.action('Ds/Playlist 1 SetShuffle "1"')};lpecMessages.playlistShuffleOff=function(){lpec.action('Ds/Playlist 1 SetShuffle "0"')};lpecMessages.playlistInsert=function(b,a){lpec.action('Ds/Media 2 PlaylistInsert "'+track+'" "Absolute"',b,errorCallback)};lpecMessages.Ds={};lpecMessages.Ds.Radio={};lpecMessages.Ds.Radio.Stop=function(){lpec.action("Ds/Radio 1 Stop")};lpecMessages.Ds.Radio.Play=function(){lpec.action("Ds/Radio 1 Play")};lpecMessages.Ds.Radio.setId=function(b,a){lpec.action('Ds/Radio 1 SetId "'+b+'" "'+a+'"')};lpecMessages.Ds.Radio.ReadList=function(a,c){var b=false;lpec.action('Ds/Radio 1 ReadList "'+a+'"',c,null,b)};lpecMessages.delaySetPresetIndex=function(a){lpec.action('Ds/Delay 1 SetPresetIndex "'+a+'"')};lpecMessages.delaySetDelay=function(a){lpec.action('Ds/Delay 1 SetDelay "'+a+'"')};lpecMessages.delayDelay=function(a){lpec.action("Ds/Delay 1 Delay",a,null,false)};lpecMessages._start=function(){lpecMessages.ds="Ds/Product";lpecMessages.ds="Ds/Playlist";if(configuration.preAmpType==1){lpecMessages.volume="Ds/Volume"}else{lpecMessages.volume="Preamp/Volume"}};elab.add("lpecMessages",null,lpecMessages._start);var linnControl={};linnControl.PREAMP_TYPE={NONE:0,INTERNAL:1,EXTERNAL:2};linnControl.LIPSYNC_TYPE={NONE:0,BASIC:1,ADVANCED:2};linnControl.currentLipsyncState={type:linnControl.LIPSYNC_TYPE.NONE,index:0,delay:0};linnControl.lipsyncDelta=10;linnControl.lipsyncDelayMax=2000;linnControl.lipsyncDelayMin=50;linnControl.initialise=function(c,b,a){try{lpec.initialiseActionSocket(c);lpec.initialiseEventSocket(c)}catch(d){}lpecMessages.ds="Ds/Product";if(b==linnControl.PREAMP_TYPE.NONE){return}else{if(b==linnControl.PREAMP_TYPE.INTERNAL){linnControl.setInternalSource(a);lpecMessages.volume="Ds/Volume"}else{if(b==linnControl.PREAMP_TYPE.EXTERNAL){linnControl.setExternalSource(a);lpecMessages.volume="Preamp/Volume"}else{return}}}};linnControl.mute=function(){lpecMessages.mute()};linnControl.unMute=function(){lpecMessages.unMute()};linnControl.volumeInc=function(){lpecMessages.volumeInc()};linnControl.volumeDec=function(){lpecMessages.volumeDec()};linnControl.powerOn=function(){lpecMessages.dsSetStandby("0")};linnControl.powerOff=function(){lpecMessages.dsSetStandby(1)};linnControl.setInternalSource=function(a){lpecMessages.dsSetSourceIndex(a)};linnControl.setExternalSource=function(a){lpecMessages.preampSetSourceIndex(a)};linnControl.enableBasicLipsync=function(a){a-=1;linnControl.currentLipsyncState.type=linnControl.LIPSYNC_TYPE.BASIC;linnControl.currentLipsyncState.index=a;lpecMessages.delaySetPresetIndex(a);lpecMessages.delayDelay(linnControl.callbackDelay)};linnControl.callbackDelay=function(a){linnControl.currentLipsyncState.delay=parseInt(a)};linnControl.lipsyncInc=function(){if(linnControl.currentLipsyncState.type!=linnControl.LIPSYNC_TYPE.BASIC){return}linnControl.currentLipsyncState.delay+=linnControl.lipsyncDelta;if(linnControl.currentLipsyncState.delay>linnControl.lipsyncDelayMax){linnControl.currentLipsyncState.delay=linnControl.lipsyncDelayMax}lpecMessages.delaySetDelay(linnControl.currentLipsyncState.delay)};linnControl.lipsyncDec=function(){if(linnControl.currentLipsyncState.type!=linnControl.LIPSYNC_TYPE.BASIC){return}linnControl.currentLipsyncState.delay-=linnControl.lipsyncDelta;if(linnControl.currentLipsyncState.delay<linnControl.lipsyncDelayMin){linnControl.currentLipsyncState.delay=linnControl.lipsyncDelayMin}lpecMessages.delaySetDelay(linnControl.currentLipsyncState.delay)};